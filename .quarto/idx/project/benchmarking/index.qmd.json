{"title":"Can Ravens Forecast?","markdown":{"yaml":{"title":"Can Ravens Forecast?","date":"2018-07-29","categories":["R","time series","forecast"],"description":"Time series forecasting using cloud services spend data"},"headingText":"Use walk to suppress the printing of list element numbers","containsRefs":false,"markdown":"\n\n![](feature.gif){fig-alt=\"A silhouette of the Houses of Parliament with rain pouring down on a man holding an umbrella and a raven swooping across the sky\"}\n\nHumans have the magical ability to plan for future events, for future gain. It's [not quite a uniquely human trait](https://www.newscientist.com/article/2140668-ravens-can-plan-for-future-as-well-as-4-year-old-children-can/). Because apparently ravens can match a four-year-old.\n\nAn abundance of data, and some very nice R packages, make our ability to plan all the more powerful.\n\nIn the Spring of 2018 I looked at sales from an historical perspective in [Six Months Later.](/project/six). Here I'll use the data to model a time-series forecast for the year ahead. The techniques apply to any time series with characteristics of trend, seasonality or longer-term cycles.\n\nWhy forecast sales? Business plans require a budget, e.g. for resources, marketing and office space. A good projection of revenue provides the foundation for the budget. And, for an established business, with historical data, time-series forecasting is one way to deliver a robust projection.\n\nWithout exogenous data, the forecast assumes one continues to do what one's doing. So, it provides a good starting-point. Then one might, for example, add assumptions about new products or services. And, if there is forward-looking data available, for example, market size projections (with past projections to train the model), then one could feed this into the forecast modelling too.\n\n```{r}\n#| label: libraries\n\nlibrary(conflicted)\nlibrary(tidyverse)\nconflict_prefer_all(\"dplyr\")\nlibrary(wesanderson)\nlibrary(fpp3)\nlibrary(scales)\nlibrary(clock)\nlibrary(usedthese)\n\nconflict_scout()\n```\n\n```{r}\n#| label: theme\n#| fig-height: 2\n#| dev.args: { bg: \"transparent\" }\n\ntheme_set(theme_bw())\n\n(cols <- wes_palette(name = \"IsleofDogs2\"))\n```\n\nFirst I'll check the encoding of the data.\n\n```{r}\n#| label: encoding\n\nurl <-\n  \"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/\"\n\ngcloud_csv <- str_c(url, \"703943/G-Cloud_spend_data_to_end_March_2018.csv\")\n\ndos_csv <- str_c(url, \"703952/DOS_spend_data_to_end_March_2018.csv\")\n\nnames <- c(gcloud_csv, dos_csv)\n\n\nwalk(names, \\(x) {\n  p <- guess_encoding(x)\n  print(p)\n})\n```\n\nNext I'll set up a vector of column names to apply consistently to both files, and import the data with the suggested encoding.\n\n```{r}\n#| label: read\n\ncolnam <- \n  c(\"sector\",\n    \"lot\",\n    \"date\",\n    \"spend\",\n    \"status\",\n    \"supplier\",\n    \"customer\",\n    \"framework\")\n\nread_dm <- \\(x){\n  read_csv(\n    x,\n    col_names = colnam,\n    skip = 1,\n    locale = locale(encoding = \"ISO-8859-1\"),\n    show_col_types = FALSE)\n}\n\nraw <- map(names, read_dm) |> \n  set_names(c(\"gcloud\", \"dos\")) |> \n  bind_rows() |> \n  mutate(framework = if_else(is.na(framework), \"DOS\", framework))\n```\n\nI'd like to create some new features: Month-end dates, something to distinguish between the two frameworks (*G-Cloud* or *DOS*). The spend has a messy format and needs a bit of cleaning too.\n\nThe lot structure for *G-Cloud* has evolved over time, but fortunately, there is a simple mapping, i.e. *PaaS* and *IaaS* became *Cloud Hosting*, *SaaS* became *Cloud Software*, and *Specialist Cloud Services* became *Cloud Support*, so I'll standardise on the latter.\n\n```{r}\n#| label: mutate\n\nboth <- raw |>\n  mutate(\n    month_end = date_parse(str_c(date, \"01\", sep = \"-\"), \n                           format = \"%b-%y-%d\") |> \n      add_months(1) |> add_days(-1),\n    date = yearmonth(month_end),\n    framework = str_extract(framework, \".{3,7}\"),\n    spend = str_remove(spend, coll(\"£\")),\n    spend = str_replace(spend, \"^\\\\(\", \"-\"),\n    spend = parse_number(spend) / 1000000,\n    lot = recode(\n      lot,\n      \"Software as a Service (SaaS)\" = \"Cloud Software\",\n      \"Infrastructure as a Service (IaaS)\" = \"Cloud Hosting\",\n      \"Platform as a Service (PaaS)\" = \"Cloud Hosting\",\n      \"Specialist Cloud Services\" = \"Cloud Support\"\n      )\n)\n```\n\nThe tidied data now needs to be converted to a [tsibble](https://github.com/tidyverts/tsibble)[@tsibble], the temporal equivalent of a [tibble](https://tibble.tidyverse.org)[@tibble].\n\nR has evolved since I first wrote this post. At that time, it was necessary to either split the data into the two frameworks (G-Cloud and DOS) and forecast them separately. Or, as I did with the three G-Cloud lots, use the purrr package to iterate through a forecast.\n\nThe tsibble package combined with the newer fable[@fable] and feasts[@feasts] packages, make this easier. One of the defining feature of the tsibble is the `key`. I want a model for each framework, so I'm setting this as the tsibble `key` (and the temporal variable as the tsibble `index`).\n\n```{r}\n#| label: plot sales\n\nboth_ts <- both |>\n  summarise(spend = sum(spend), .by = c(date, framework)) |> \n  as_tsibble(key = framework, index = date)\n\nboth_ts |> \n  ggplot(aes(date, spend, colour = framework)) +\n  geom_line(key_glyph = \"timeseries\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  scale_colour_manual(values = cols[c(3, 4)]) +\n  labs(x = NULL, y = NULL, title = \"Monthly Digital Marketplace Sales\")\n```\n\nBy decomposing the historical data we can tease out the underlying trend and seasonality:\n\n-   **Trend**: The sales for both frameworks have grown over time as more Suppliers have added their services to the Government frameworks, and more Public Sector organizations have found the benefits of purchasing Cloud services through this faster, simpler, more transparent and more competitive contracting vehicle.\n\n-   **Seasonality**: Suppliers often manage their sales and financials based on a quarterly cycle, with a particular emphasis on a strong close to the financial year. And Government Buyers may want to make optimal use of their budgets at the close of their financial year (March 31st). Consequently, we see quarterly seasonality with an extra spike at financial year-end.\n\n```{r}\n#| label: decomposition\n\nboth_ts |>\n  model(stl = STL(spend ~ trend(window = 7) + season(window = \"periodic\"))) |>\n  components() |>\n  autoplot() +\n  scale_colour_manual(values = cols[c(3, 4)]) +\n  labs(x = NULL, title = \"Time Series Decomposition\")\n```\n\nI'll use `auto.arima`: [AutoRegressive Integrated Moving Average](https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average) modelling which aims to describe the autocorrelations in the data.\n\nBy setting `stepwise` and `approximation` to `FALSE`, `auto.arima` will explore a wider range of potential models.\n\nI'll forecast with the default 80% and 95% prediction intervals. This means the darker-shaded 80% range should include the future sales value with an 80% probability. Likewise with a 95% probability when adding the wider and lighter-shaded area.\n\nUse of `autoplot` would simplify the code, but personally I like to expose all the data, for example unpacking the prediction intervals, and have finer control over the visualisation.","srcMarkdownNoYaml":"\n\n![](feature.gif){fig-alt=\"A silhouette of the Houses of Parliament with rain pouring down on a man holding an umbrella and a raven swooping across the sky\"}\n\nHumans have the magical ability to plan for future events, for future gain. It's [not quite a uniquely human trait](https://www.newscientist.com/article/2140668-ravens-can-plan-for-future-as-well-as-4-year-old-children-can/). Because apparently ravens can match a four-year-old.\n\nAn abundance of data, and some very nice R packages, make our ability to plan all the more powerful.\n\nIn the Spring of 2018 I looked at sales from an historical perspective in [Six Months Later.](/project/six). Here I'll use the data to model a time-series forecast for the year ahead. The techniques apply to any time series with characteristics of trend, seasonality or longer-term cycles.\n\nWhy forecast sales? Business plans require a budget, e.g. for resources, marketing and office space. A good projection of revenue provides the foundation for the budget. And, for an established business, with historical data, time-series forecasting is one way to deliver a robust projection.\n\nWithout exogenous data, the forecast assumes one continues to do what one's doing. So, it provides a good starting-point. Then one might, for example, add assumptions about new products or services. And, if there is forward-looking data available, for example, market size projections (with past projections to train the model), then one could feed this into the forecast modelling too.\n\n```{r}\n#| label: libraries\n\nlibrary(conflicted)\nlibrary(tidyverse)\nconflict_prefer_all(\"dplyr\")\nlibrary(wesanderson)\nlibrary(fpp3)\nlibrary(scales)\nlibrary(clock)\nlibrary(usedthese)\n\nconflict_scout()\n```\n\n```{r}\n#| label: theme\n#| fig-height: 2\n#| dev.args: { bg: \"transparent\" }\n\ntheme_set(theme_bw())\n\n(cols <- wes_palette(name = \"IsleofDogs2\"))\n```\n\nFirst I'll check the encoding of the data.\n\n```{r}\n#| label: encoding\n\nurl <-\n  \"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/\"\n\ngcloud_csv <- str_c(url, \"703943/G-Cloud_spend_data_to_end_March_2018.csv\")\n\ndos_csv <- str_c(url, \"703952/DOS_spend_data_to_end_March_2018.csv\")\n\nnames <- c(gcloud_csv, dos_csv)\n\n# Use walk to suppress the printing of list element numbers\n\nwalk(names, \\(x) {\n  p <- guess_encoding(x)\n  print(p)\n})\n```\n\nNext I'll set up a vector of column names to apply consistently to both files, and import the data with the suggested encoding.\n\n```{r}\n#| label: read\n\ncolnam <- \n  c(\"sector\",\n    \"lot\",\n    \"date\",\n    \"spend\",\n    \"status\",\n    \"supplier\",\n    \"customer\",\n    \"framework\")\n\nread_dm <- \\(x){\n  read_csv(\n    x,\n    col_names = colnam,\n    skip = 1,\n    locale = locale(encoding = \"ISO-8859-1\"),\n    show_col_types = FALSE)\n}\n\nraw <- map(names, read_dm) |> \n  set_names(c(\"gcloud\", \"dos\")) |> \n  bind_rows() |> \n  mutate(framework = if_else(is.na(framework), \"DOS\", framework))\n```\n\nI'd like to create some new features: Month-end dates, something to distinguish between the two frameworks (*G-Cloud* or *DOS*). The spend has a messy format and needs a bit of cleaning too.\n\nThe lot structure for *G-Cloud* has evolved over time, but fortunately, there is a simple mapping, i.e. *PaaS* and *IaaS* became *Cloud Hosting*, *SaaS* became *Cloud Software*, and *Specialist Cloud Services* became *Cloud Support*, so I'll standardise on the latter.\n\n```{r}\n#| label: mutate\n\nboth <- raw |>\n  mutate(\n    month_end = date_parse(str_c(date, \"01\", sep = \"-\"), \n                           format = \"%b-%y-%d\") |> \n      add_months(1) |> add_days(-1),\n    date = yearmonth(month_end),\n    framework = str_extract(framework, \".{3,7}\"),\n    spend = str_remove(spend, coll(\"£\")),\n    spend = str_replace(spend, \"^\\\\(\", \"-\"),\n    spend = parse_number(spend) / 1000000,\n    lot = recode(\n      lot,\n      \"Software as a Service (SaaS)\" = \"Cloud Software\",\n      \"Infrastructure as a Service (IaaS)\" = \"Cloud Hosting\",\n      \"Platform as a Service (PaaS)\" = \"Cloud Hosting\",\n      \"Specialist Cloud Services\" = \"Cloud Support\"\n      )\n)\n```\n\nThe tidied data now needs to be converted to a [tsibble](https://github.com/tidyverts/tsibble)[@tsibble], the temporal equivalent of a [tibble](https://tibble.tidyverse.org)[@tibble].\n\nR has evolved since I first wrote this post. At that time, it was necessary to either split the data into the two frameworks (G-Cloud and DOS) and forecast them separately. Or, as I did with the three G-Cloud lots, use the purrr package to iterate through a forecast.\n\nThe tsibble package combined with the newer fable[@fable] and feasts[@feasts] packages, make this easier. One of the defining feature of the tsibble is the `key`. I want a model for each framework, so I'm setting this as the tsibble `key` (and the temporal variable as the tsibble `index`).\n\n```{r}\n#| label: plot sales\n\nboth_ts <- both |>\n  summarise(spend = sum(spend), .by = c(date, framework)) |> \n  as_tsibble(key = framework, index = date)\n\nboth_ts |> \n  ggplot(aes(date, spend, colour = framework)) +\n  geom_line(key_glyph = \"timeseries\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  scale_colour_manual(values = cols[c(3, 4)]) +\n  labs(x = NULL, y = NULL, title = \"Monthly Digital Marketplace Sales\")\n```\n\nBy decomposing the historical data we can tease out the underlying trend and seasonality:\n\n-   **Trend**: The sales for both frameworks have grown over time as more Suppliers have added their services to the Government frameworks, and more Public Sector organizations have found the benefits of purchasing Cloud services through this faster, simpler, more transparent and more competitive contracting vehicle.\n\n-   **Seasonality**: Suppliers often manage their sales and financials based on a quarterly cycle, with a particular emphasis on a strong close to the financial year. And Government Buyers may want to make optimal use of their budgets at the close of their financial year (March 31st). Consequently, we see quarterly seasonality with an extra spike at financial year-end.\n\n```{r}\n#| label: decomposition\n\nboth_ts |>\n  model(stl = STL(spend ~ trend(window = 7) + season(window = \"periodic\"))) |>\n  components() |>\n  autoplot() +\n  scale_colour_manual(values = cols[c(3, 4)]) +\n  labs(x = NULL, title = \"Time Series Decomposition\")\n```\n\nI'll use `auto.arima`: [AutoRegressive Integrated Moving Average](https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average) modelling which aims to describe the autocorrelations in the data.\n\nBy setting `stepwise` and `approximation` to `FALSE`, `auto.arima` will explore a wider range of potential models.\n\nI'll forecast with the default 80% and 95% prediction intervals. This means the darker-shaded 80% range should include the future sales value with an 80% probability. Likewise with a 95% probability when adding the wider and lighter-shaded area.\n\nUse of `autoplot` would simplify the code, but personally I like to expose all the data, for example unpacking the prediction intervals, and have finer control over the visualisation."},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"kable","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../scss/styles.css"],"highlight-style":"gruvbox","output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.32","editor":"visual","theme":{"light":["flatly","../../scss/light.scss"],"dark":["darkly","../../scss/dark.scss"]},"smooth-scroll":true,"comments":{"giscus":{"repo":"luka-kovaceivc/luka-kovacevic.github.io","category":"Comments","mapping":"pathname","reactions-enabled":true,"loading":"lazy","input-position":"bottom","theme":{"light":"light_high_contrast","dark":"dark_dimmed"}}},"author":"Luka Kovačević","date-modified":"last-modified","knitr":{"opts_chunk":{"out.width":"100%"}},"code-annotations":"hover","title":"Can Ravens Forecast?","date":"2018-07-29","categories":["R","time series","forecast"],"description":"Time series forecasting using cloud services spend data"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}